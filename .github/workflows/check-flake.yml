name: Check flake

on:
  pull_request:
  push:
    branches: [main]

jobs:
  check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: DeterminateSystems/nix-installer-action@main

      - uses: DeterminateSystems/magic-nix-cache-action@main

      - name: nix flake check
        run: nix flake check --all-systems --no-build

      - name: Evaluate nixosConfigurations
        run: |
          for host in ariel dione hyperion pallas; do
            echo "Evaluating nixosConfigurations.$host..."
            nix eval .#nixosConfigurations.$host.config.system.build.toplevel --raw > /dev/null
          done

      - name: Evaluate homeConfigurations
        run: |
          echo "Evaluating homeConfigurations.sebastien..."
          nix eval .#homeConfigurations.sebastien.activationPackage --raw > /dev/null
